<!DOCTYPE html>
<html>
<head>
  <title>Global Financial Aid to Ukraine</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.7.0/dist/leaflet.css"/>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #f7f7f7;
    }

    /* ===== HEADER BAR ===== */
    header {
      width: 100%;
      background: #003366;
      color: white;
      padding: 18px 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    /* ===== INTRO / DESCRIPTION BOX ===== */
    .intro-box {
      max-width: 1100px;
      margin: 20px auto 10px auto;
      background: white;
      padding: 18px 22px;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      line-height: 1.5em;
      font-size: 16px;
    }

    /* ===== MAP AREA ===== */
    #map {
      width: 100%;
      height: calc(100% - 220px); /* leaves room for header + intro */
      margin-top: 10px;
    }

    /* ===== FILTER BUTTON GROUP (moves to top left of MAP) ===== */
    .filter-buttons {
      position: absolute;
      top: 20px;           /* visually below intro box */
      left: 20px;
      z-index: 9999;
      background: rgba(255,255,255,0.95);
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
      display: flex;
      gap: 6px;
    }
    .filter-buttons button {
      padding: 6px 12px;
      border: 1px solid #777;
      background: #f2f2f2;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.2s;
    }
    .filter-buttons button:hover {
      background: #e0e0e0;
    }
    .filter-buttons button.active {
      background: #bcd4ff;
      border-color: #4a7bd0;
    }

    /* ===== LEGEND ===== */
    .legend {
      z-index: 1000;
      position: absolute;
      right: 20px;
      bottom: 20px;
      padding: 6px 8px;
      font: 14px Arial, Helvetica, sans-serif;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
      line-height: 18px;
    }
    .legend i {
      width: 18px;
      height: 16px;
      float: left;
      margin-right: 8px;
      opacity: 0.8;
    }

  </style>

  <!-- JS -->
  <script src="https://unpkg.com/leaflet@1.7.0/dist/leaflet.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>
</head>

<body>

<header>
  Global Financial Aid to Ukraine
</header>

<div class="intro-box">
  This map displays financial support provided to Ukraine as a percentage of 
  each donating country's 2021 GDP. The data used accounts for money already 
  spent as well as future allocations countries plan to deliver. This covers 
  financial assistance provided between the dates of 01/24/2022 and 08/31/2025. 
  The figures are representative of total aid provided, including both 
  humanitarian and military, however this “does not include private donations, 
  support for refugees outside of Ukraine and aid by international 
  organizations”.
</div>

<!-- FILTER BUTTON GROUP (now positioned cleanly at top-left of map) -->
<div class="filter-buttons">
  <button id="showAll" class="active">All Countries</button>
  <button id="showEU">EU Only</button>
  <button id="showNonEU">Non-EU Only</button>
</div>

<div id="map"></div>
<div class="legend"></div>

<script>
  // ---------------------------------------------------
  // 1. Map setup
  // ---------------------------------------------------
  const map = L.map('map').setView([20, 0], 2);

  const baseLayer = L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
    {
      attribution: '&copy; CARTO',
      subdomains: 'abcd',
      maxZoom: 19
    }
  ).addTo(map);

  // ---------------------------------------------------
  // 2. EU country names (must match GeoJSON "name")
  // ---------------------------------------------------
  const EU_COUNTRIES = [
    "Austria","Belgium","Bulgaria","Croatia","Cyprus","Czechia","Denmark",
    "Estonia","Finland","France","Germany","Greece","Hungary","Ireland",
    "Italy","Latvia","Lithuania","Luxembourg","Malta","Netherlands",
    "Poland","Portugal","Romania","Slovakia","Slovenia","Spain","Sweden"
  ];

  // ---------------------------------------------------
  // 3. Helper functions
  // ---------------------------------------------------
  function getISO3(props) {
    return (
      props.ISO_A3 ||
      props.ADM0_A3 ||
      props.ISO3 ||
      props["ISO3166-1-Alpha-3"] ||
      props.iso3 ||
      ''
    ).toUpperCase();
  }

  function getColor(value) {
    if (value === null || value === undefined || isNaN(value)) {
      return '#CCCCCC';
    }
    for (let i = 0; i < breaks.length - 1; i++) {
      if (value >= breaks[i] && value <= breaks[i + 1]) {
        return colors[i];
      }
    }
    return colors[colors.length - 1];
  }

  let breaks = [];
  let colors = [];
  let aidLookup = {};

  let fullLayer, euLayer, nonEuLayer;

  // ---------------------------------------------------
  // 4. Load data
  // ---------------------------------------------------
  $.when(
    $.getJSON("assets/countries.geojson"),
    $.getJSON("assets/financial_support_ukraine.json")
  ).done(function(geoData, aidData) {

    // Build lookup
    aidData[0].forEach(d => {
      if (d.iso3 && d.total_aid_percent_gdp !== null) {
        aidLookup[d.iso3.toUpperCase()] = Number(d.total_aid_percent_gdp);
      }
    });

    // Build quantile color breaks
    const values = Object.values(aidLookup)
      .filter(v => !isNaN(v))
      .sort((a,b) => a-b);

    breaks = chroma.limits(values, 'q', 5);
    colors = chroma.scale('YlOrRd').colors(5);

    // Create layers
    fullLayer = createLayer(geoData[0], () => true);
    euLayer   = createLayer(geoData[0], f => EU_COUNTRIES.includes(f.properties.name));
    nonEuLayer= createLayer(geoData[0], f => !EU_COUNTRIES.includes(f.properties.name));

    fullLayer.addTo(map);

    buildLegend();
    configureFilterButtons();
  });

  // ---------------------------------------------------
  // 5. Create filtered layer
  // ---------------------------------------------------
  function createLayer(geojson, filterFunc) {
    return L.geoJson(geojson, {
      filter: filterFunc,
      style: function(feature) {
        const iso3 = getISO3(feature.properties);
        const value = aidLookup[iso3];
        return {
          weight: 1,
          opacity: 1,
          color: '#777',
          fillOpacity: 0.75,
          fillColor: getColor(value)
        };
      },
      onEachFeature: function(feature, layer) {
        const iso3 = getISO3(feature.properties);
        const value = aidLookup[iso3];
        const name = feature.properties.name;

        const popup =
          `<strong>${name}</strong><br>` +
          (value !== undefined
            ? `Aid to Ukraine: ${value.toFixed(2)}% of GDP`
            : "No data available");

        layer.bindPopup(popup);
      }
    });
  }

  // ---------------------------------------------------
  // 6. Filter button logic
  // ---------------------------------------------------
  function configureFilterButtons() {
    const btnAll = document.getElementById("showAll");
    const btnEU = document.getElementById("showEU");
    const btnNon = document.getElementById("showNonEU");

    function setActive(btn) {
      document.querySelectorAll(".filter-buttons button")
        .forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    }

    btnAll.onclick = () => {
      setActive(btnAll);
      swapLayer(fullLayer);
    };
    btnEU.onclick = () => {
      setActive(btnEU);
      swapLayer(euLayer);
    };
    btnNon.onclick = () => {
      setActive(btnNon);
      swapLayer(nonEuLayer);
    };
  }

  function swapLayer(layerToAdd) {
    [fullLayer, euLayer, nonEuLayer].forEach(layer => {
      if (map.hasLayer(layer)) map.removeLayer(layer);
    });
    layerToAdd.addTo(map);
  }

  // ---------------------------------------------------
  // 7. Legend
  // ---------------------------------------------------
  function buildLegend() {
    let html = "";
    for (let i = 0; i < breaks.length - 1; i++) {
      html +=
        `<i style="background:${colors[i]}"></i> ` +
        `${breaks[i].toFixed(2)}–${breaks[i+1].toFixed(2)}%<br>`;
    }
    html += `<i style="background:#CCCCCC"></i> No data`;

    document.querySelector(".legend").innerHTML = html;
  }

</script>

</body>
</html>
